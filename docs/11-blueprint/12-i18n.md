# 12. Internationalization — i18next Setup, Type Generation, Translation Patterns

> **Audience**: AI agent building the new app
> **Purpose**: How to set up multi-language support with type-safe translation keys

---

## Architecture

```
src/i18n.ts                       # i18next initialization
src/components/I18nInitializer.tsx # Client-side provider
public/locales/
├── en/common.json                # English translations
└── fi/common.json                # Finnish translations
scripts/generate-i18n-types.mjs   # Type generator (Node.js ESM)
src/i18n-types.ts                 # Generated types
```

---

## 1. i18next Setup

```typescript
// src/i18n.ts

import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import fi from '../public/locales/fi/common.json';
import en from '../public/locales/en/common.json';

export const resources = {
  fi: { translation: fi },
  en: { translation: en },
} as const;

const LANGUAGE_PREF_KEY = 'practice_planner_language';

// Load language preference from localStorage (NOT IndexedDB)
// Language is a device preference, not user data — don't use DataStore
const loadLanguagePreference = async (): Promise<void> => {
  try {
    const saved = localStorage.getItem(LANGUAGE_PREF_KEY) || 'fi';
    if (saved !== i18n.language) {
      await i18n.changeLanguage(saved);
    }
  } catch {
    // Silently fail — keep default
  }
};

export const saveLanguagePreference = (language: string): void => {
  try {
    localStorage.setItem(LANGUAGE_PREF_KEY, language);
  } catch {
    // localStorage might be full
  }
};

// Initialize with default language synchronously
const IS_TEST = typeof process !== 'undefined' && process.env.JEST_WORKER_ID !== undefined;
const defaultLang = IS_TEST ? 'en' : 'fi';

if (!i18n.isInitialized) {
  i18n.use(initReactI18next).init({
    lng: defaultLang,
    fallbackLng: defaultLang,
    resources,
    interpolation: { escapeValue: false },
    debug: false,
    react: {
      useSuspense: false,
      bindI18n: 'languageChanged loaded',
      bindI18nStore: 'added removed',
      transSupportBasicHtmlNodes: true,
      transKeepBasicHtmlNodesFor: ['br', 'strong', 'i', 'p', 'span'],
    },
  }).then(() => {
    if (typeof window !== 'undefined' && !IS_TEST) {
      loadLanguagePreference();
    }
  });
}

export default i18n;
```

**Key decisions**:
- **Bundled translations** (not fetched at runtime) — works offline, no loading delay
- **localStorage for language preference** — NOT IndexedDB/DataStore. Language loads before auth resolves, and trying to access DataStore during i18n init causes race conditions
- **English in tests, Finnish in production** — test assertions are easier in English
- **`useSuspense: false`** — prevents hydration errors with SSR

---

## 2. I18nInitializer Component

```tsx
// src/components/I18nInitializer.tsx

'use client';

import { useState, useEffect } from 'react';
import { I18nextProvider } from 'react-i18next';
import i18n from '../i18n';

export default function I18nInitializer({ children }: { children: React.ReactNode }) {
  const [isReady, setIsReady] = useState(i18n.isInitialized);

  useEffect(() => {
    if (!i18n.isInitialized) {
      const handler = () => setIsReady(true);
      i18n.on('initialized', handler);
      return () => { i18n.off('initialized', handler); };
    }
  }, []);

  if (!isReady) {
    // Show locale-aware loading text BEFORE i18n initializes
    const isFinnish = typeof navigator !== 'undefined' && navigator.language?.startsWith('fi');
    return <div>{isFinnish ? 'Ladataan...' : 'Loading...'}</div>;
  }

  return <I18nextProvider i18n={i18n}>{children}</I18nextProvider>;
}
```

---

## 3. Translation File Structure

```json
// public/locales/en/common.json

{
  "nav": {
    "home": "Home",
    "practice": "Practice",
    "exercises": "Exercises",
    "calendar": "Calendar",
    "roster": "Roster",
    "settings": "Settings"
  },
  "practice": {
    "title": "Practice Sessions",
    "create": "New Practice",
    "block": {
      "warmup": "Warm-up",
      "main": "Main Activity",
      "cooldown": "Cool-down",
      "break": "Break"
    },
    "duration": "{{minutes}} min",
    "totalDuration": "Total: {{minutes}} min"
  },
  "exercise": {
    "title": "Exercise Library",
    "create": "New Exercise",
    "search": "Search exercises...",
    "categories": {
      "passing": "Passing",
      "shooting": "Shooting",
      "dribbling": "Dribbling",
      "defending": "Defending",
      "goalkeeping": "Goalkeeping",
      "fitness": "Fitness"
    }
  },
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "confirm": "Confirm",
    "loading": "Loading...",
    "error": "An error occurred",
    "retry": "Try again"
  }
}
```

---

## 4. Usage in Components

```tsx
import { useTranslation } from 'react-i18next';

function PracticeList() {
  const { t } = useTranslation();

  return (
    <div>
      <h1>{t('practice.title')}</h1>
      <button>{t('practice.create')}</button>

      {/* Interpolation */}
      <span>{t('practice.duration', { minutes: 15 })}</span>

      {/* Pluralization (if needed) */}
      <span>{t('practice.blockCount', { count: blocks.length })}</span>
    </div>
  );
}
```

---

## 5. Type-Safe Translation Keys (Optional)

Generate TypeScript types from translation files:

```javascript
// scripts/generate-i18n-types.mjs

import { readFileSync, writeFileSync } from 'fs';
import path from 'path';

const baseLang = 'en';
const translationPath = path.resolve('public/locales', baseLang, 'common.json');
const data = JSON.parse(readFileSync(translationPath, 'utf8'));

function flatten(obj, prefix = '') {
  const keys = [];
  for (const [key, value] of Object.entries(obj)) {
    const newKey = prefix ? `${prefix}.${key}` : key;
    if (value && typeof value === 'object' && !Array.isArray(value)) {
      keys.push(...flatten(value, newKey));
    } else {
      keys.push(newKey);
    }
  }
  return keys;
}

const keys = flatten(data).sort();

const typeDef = `// AUTO-GENERATED FILE - DO NOT EDIT\n` +
  `export type TranslationKey =\n${keys.map(k => `  | '${k}'`).join('\n')};\n`;

writeFileSync('src/i18n-types.ts', typeDef);
console.log(`Generated src/i18n-types.ts with ${keys.length} keys`);
```

Add to package.json: `"generate:i18n-types": "node scripts/generate-i18n-types.mjs"`

Note: This uses plain `.mjs` (Node ESM), not `.ts`. No `ts-node` dependency needed.

---

## 6. Language Switching

```tsx
function LanguageSelector() {
  const { i18n } = useTranslation();

  const handleChange = (lang: string) => {
    i18n.changeLanguage(lang);
    saveLanguagePreference(lang);
  };

  return (
    <select value={i18n.language} onChange={e => handleChange(e.target.value)}>
      <option value="fi">Suomi</option>
      <option value="en">English</option>
    </select>
  );
}
```

---

## Traps

1. **Language preference in localStorage, NOT DataStore**: DataStore requires auth to be initialized. i18n initializes before auth. Using DataStore for language causes race conditions.

2. **Bundled translations, not HTTP-fetched**: PWA must work offline. Fetching translations at runtime breaks offline mode.

3. **English for tests**: Asserting `expect(screen.getByText('Lataa...')` is fragile. Use English in test environment.

4. **`useSuspense: false`**: Required to prevent hydration mismatch between server (no i18n) and client (i18n initialized).

5. **HTML in translations**: Use `<Trans>` component for strings with embedded HTML, not raw string interpolation.
