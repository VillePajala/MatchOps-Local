# Layer 2 â€” Step 2.7: useGameOrchestration Cleanup

**Status**: ðŸ”´ **NOT STARTED**
**Priority**: ðŸ”´ **HIGH** â€” Required to complete refactoring
**Estimated Effort**: 4-6 hours
**Prerequisites**: Step 2.6 (hook extractions) âœ… Complete

---

## Problem Statement

The 6 hooks were **created** in Step 2.6, but the original code in `useGameOrchestration.ts` was **not removed**.

| Metric | Expected After 2.6 | Actual |
|--------|-------------------|--------|
| useGameOrchestration.ts | ~200 lines | **2,199 lines** |

**Root Cause**: Code was copied to new hooks but not deleted from the original file.

---

## Current State Analysis

### What's Already Working (Hooks ARE Being Called)
The 6 extracted hooks ARE imported and called (lines 135-413):
- `useGameSessionCoordination` (line 135)
- `useFieldCoordination` (line 181)
- `useGameDataManagement` (line 273)
- `useTimerManagement` (line 405)
- `useGamePersistence` (line 1181)
- `useModalOrchestration` (called via context)

### What Needs to Be Removed
The file contains **~2,000 lines** of:
1. **Duplicate state declarations** - useState calls that duplicate hook state
2. **Duplicate handlers** - useCallback functions that duplicate hook functions
3. **Dead effects** - useEffect that run logic now in hooks
4. **Legacy imports** - imports no longer needed
5. **Commented-out code** - TODO comments marking what "moved to X hook"

---

## Goal

Reduce `useGameOrchestration.ts` from **2,199 lines to ~200-300 lines** by:
1. Removing duplicate code that now lives in extracted hooks
2. Converting useGameOrchestration into a thin coordination layer
3. Ensuring all functionality still works through the extracted hooks

---

## Branch Strategy

### Integration Branch Pattern

```
master
  â””â”€â”€ integration/2.7-orchestration-cleanup   (integration branch)
        â”œâ”€â”€ refactor/2.7.1-cleanup-data-management
        â”œâ”€â”€ refactor/2.7.2-cleanup-session-field
        â”œâ”€â”€ refactor/2.7.3-cleanup-persistence-timer
        â””â”€â”€ refactor/2.7.4-final-cleanup
```

### Workflow

1. **Create integration branch from master**:
   ```bash
   git checkout master
   git checkout -b integration/2.7-orchestration-cleanup
   git push -u origin integration/2.7-orchestration-cleanup
   ```

2. **Create feature branches from integration**:
   ```bash
   git checkout integration/2.7-orchestration-cleanup
   git checkout -b refactor/2.7.1-cleanup-data-management
   ```

3. **PRs target integration branch** (not master):
   - PR 1: `refactor/2.7.1-cleanup-data-management` â†’ `integration/2.7-orchestration-cleanup`
   - PR 2: `refactor/2.7.2-cleanup-session-field` â†’ `integration/2.7-orchestration-cleanup`
   - PR 3: `refactor/2.7.3-cleanup-persistence-timer` â†’ `integration/2.7-orchestration-cleanup`
   - PR 4: `refactor/2.7.4-final-cleanup` â†’ `integration/2.7-orchestration-cleanup`

4. **Final PR to master**:
   - After all 4 PRs merged to integration
   - Final PR: `integration/2.7-orchestration-cleanup` â†’ `master`
   - Full testing before merge

### Benefits
- Each PR can be reviewed/merged independently
- Easy to test combined changes before master
- Can revert individual PRs within integration
- Master stays stable throughout

---

## Target Architecture

After cleanup, `useGameOrchestration.ts` should be:

```typescript
export function useGameOrchestration(props: UseGameOrchestrationProps) {
  // 1. Call extracted hooks (6 hooks)
  const dataManagement = useGameDataManagement();
  const sessionCoordination = useGameSessionCoordination({ ... });
  const fieldCoordination = useFieldCoordination({ ... });
  const persistence = useGamePersistence({ ... });
  const timerManagement = useTimerManagement({ ... });
  const modalOrchestration = useModalOrchestration({ ... });

  // 2. Wire hooks together (handle inter-hook coordination)
  // - handleUndo/handleRedo (coordinates field + session)
  // - Bootstrap/reset flows
  // - Initial action handling

  // 3. Build and return view-model props
  const gameContainerProps = buildGameContainerViewModel({ ... });

  return {
    gameContainerProps,
    modalManagerProps: modalOrchestration.modalManagerProps,
    isBootstrapping,
    isResetting,
  };
}
```

---

## PR Breakdown (4 PRs)

### PR 1: Remove Data Management Duplicates (~1 hour)
**Branch**: `refactor/2.7.1-cleanup-data-management`
**Base**: `integration/2.7-orchestration-cleanup`

**What to Remove**:
- Duplicate `seasons` and `tournaments` state (lines 269-270) - use `gameDataManagement.seasons/tournaments`
- Duplicate React Query hooks (if any remain)
- Duplicate data fetching effects
- Unused imports for seasons/tournaments utilities

**Key Changes**:
- Replace `seasons` with `gameDataManagement.seasons`
- Replace `tournaments` with `gameDataManagement.tournaments`
- Remove `setSeasons` and `setTournaments` callbacks

**Verification**:
- [ ] Seasons dropdown populates
- [ ] Tournaments dropdown populates
- [ ] Add/edit/delete season/tournament works
- [ ] Tests pass

---

### PR 2: Remove Session & Field Duplicates (~1.5 hours)
**Branch**: `refactor/2.7.2-cleanup-session-field`
**Base**: `integration/2.7-orchestration-cleanup`

**What to Remove**:
- Any duplicate game session state management
- Duplicate history management callbacks
- Duplicate field state handlers
- Commented-out state declarations (lines 234-241)
- Duplicate tactical board state

**Keep**:
- `handleUndo`/`handleRedo` (lines 201-231) - these COORDINATE multiple hooks
- Destructured values from hooks that are used elsewhere

**Verification**:
- [ ] Game session updates correctly
- [ ] Undo/redo works
- [ ] Field interactions work
- [ ] Tactical board works
- [ ] Tests pass

---

### PR 3: Remove Persistence & Timer Duplicates (~1.5 hours)
**Branch**: `refactor/2.7.3-cleanup-persistence-timer`
**Base**: `integration/2.7-orchestration-cleanup`

**What to Remove**:
- Duplicate auto-save logic
- Duplicate save/load handlers
- Legacy auto-save effects (line 1155 area)
- Duplicate timer state derivations
- Duplicate goal logging handlers

**Keep**:
- `persistence` hook call and its destructured values
- `timerManagement` hook call and its destructured values

**Verification**:
- [ ] Auto-save works (check IndexedDB)
- [ ] Manual save works
- [ ] Load game works
- [ ] Timer starts/stops/resets correctly
- [ ] Goal logging works
- [ ] Tests pass

---

### PR 4: Remove Modal Duplicates & Final Cleanup (~1 hour)
**Branch**: `refactor/2.7.4-final-cleanup`
**Base**: `integration/2.7-orchestration-cleanup`

**What to Remove**:
- Duplicate modal state (use `modalOrchestration` values)
- Duplicate modal handlers
- Unused imports (audit all imports)
- Dead code
- Excessive comments about "moved to X hook"
- `initialState` object (move to `@/config/initialState.ts` if needed)

**Final File Should Be**:
- ~200-300 lines
- Only coordination logic
- All state management delegated to hooks
- Clean imports

**Verification**:
- [ ] All modals work
- [ ] All flows work end-to-end
- [ ] No console errors
- [ ] Tests pass
- [ ] Build succeeds
- [ ] Lint passes

---

## Testing Strategy

### Test-First Verification (Deletion TDD)

Since this is a **deletion task** (not creation), traditional TDD doesn't apply. Instead, we use **Test-First Verification**:

1. **Before ANY deletion**: Run full test suite, record baseline
2. **After EACH deletion block**: Run tests immediately
3. **If tests fail**: The deleted code was still needed - restore and investigate
4. **If tests pass**: Safe to continue

This ensures we never delete code that's actually being used.

### Workflow Per PR

```bash
# 1. BEFORE starting deletions
npm test -- --no-coverage
# Record: X tests passing

# 2. AFTER each logical deletion (e.g., removing one useState)
npm test -- --no-coverage
# Verify: Still X tests passing

# 3. AFTER PR complete
npm test
npm run build
npm run lint
```

### Why Not Traditional TDD?

- We're **removing** code, not adding functionality
- The extracted hooks already have 61-100% test coverage
- Existing tests ARE our safety net
- "Green tests after deletion" = deletion was safe

### Before Starting
```bash
npm test -- --no-coverage
# Record baseline: 2,025 tests passing

npm run build
# Verify build succeeds
```

### After Each PR
```bash
npm test
npm run build
npm run lint
```

### After Final PR (Integration â†’ Master)
1. Full test suite
2. Manual testing of all flows:
   - New game creation
   - Load/save game
   - Field interactions
   - Timer operations
   - All modals (settings, stats, roster, etc.)
   - Export functions
3. PWA install and test
4. Test in both English and Finnish

---

## Rollback Strategy

### Within Integration Branch
Each feature PR can be reverted independently:
```bash
git checkout integration/2.7-orchestration-cleanup
git revert <commit-hash>
```

### Abandon Integration Branch
If major issues found, simply don't merge to master:
```bash
git checkout master
git branch -D integration/2.7-orchestration-cleanup
```

Keep original `useGameOrchestration.ts` in git history for reference.

---

## Success Criteria

- [ ] `useGameOrchestration.ts` â‰¤ 300 lines
- [ ] All 6 extracted hooks used (no duplicate logic)
- [ ] No commented-out code blocks
- [ ] All tests pass (2,025+ tests)
- [ ] All functionality preserved
- [ ] Build succeeds
- [ ] Clean lint (no warnings)
- [ ] Manual testing passes all flows

---

## Dependencies

- âœ… Step 2.6.1: useGameDataManagement (98% test coverage)
- âœ… Step 2.6.2: useGameSessionCoordination (97% test coverage)
- âœ… Step 2.6.3: useFieldCoordination (99% test coverage)
- âœ… Step 2.6.4: useGamePersistence (78% test coverage)
- âœ… Step 2.6.5: useTimerManagement (100% test coverage)
- âœ… Step 2.6.6: useModalOrchestration (61% test coverage)

---

## After This Step

Once Step 2.7 is complete:
1. **GameSettingsModal refactoring** becomes the next priority
2. See [P1-GameSettingsModal-Refactoring-Plan.md](../05-development/fix-plans/P1-GameSettingsModal-Refactoring-Plan.md)

---

**Created**: 2025-12-04
**Updated**: 2025-12-04 (Added integration branch strategy, detailed analysis)
**Document Owner**: Development Team
