# Layer 2 â€” Step 2.7: useGameOrchestration Cleanup

**Status**: ðŸ”´ **NOT STARTED**
**Priority**: ðŸ”´ **HIGH** â€” Required to complete refactoring
**Estimated Effort**: 4-6 hours
**Prerequisites**: Step 2.6 (hook extractions) âœ… Complete

---

## Problem Statement

The 6 hooks were **created** in Step 2.6, but the original code in `useGameOrchestration.ts` was **not removed**.

| Metric | Expected After 2.6 | Actual |
|--------|-------------------|--------|
| useGameOrchestration.ts | ~200 lines | **2,199 lines** |

**Root Cause**: Code was copied to new hooks but not deleted from the original file.

---

## Goal

Reduce `useGameOrchestration.ts` from **2,199 lines to ~200 lines** by:
1. Removing duplicated code that now lives in extracted hooks
2. Converting useGameOrchestration into a thin coordination layer
3. Ensuring all functionality still works through the extracted hooks

---

## Target Architecture

After cleanup, `useGameOrchestration.ts` should be:

```typescript
export function useGameOrchestration(props: UseGameOrchestrationProps) {
  // 1. Call extracted hooks (6 hooks)
  const dataManagement = useGameDataManagement();
  const sessionCoordination = useGameSessionCoordination({ ... });
  const fieldCoordination = useFieldCoordination({ ... });
  const persistence = useGamePersistence({ ... });
  const timerManagement = useTimerManagement({ ... });
  const modalOrchestration = useModalOrchestration({ ... });

  // 2. Wire hooks together (handle inter-hook coordination)
  // ...

  // 3. Build and return view-model props
  const gameContainerProps = buildGameContainerViewModel({ ... });

  return {
    gameContainerProps,
    modalManagerProps: modalOrchestration.modalManagerProps,
    isBootstrapping,
    isResetting,
  };
}
```

---

## PR Breakdown (4 PRs)

### PR 1: Remove Data Management Duplicates (~1 hour)
**Branch**: `refactor/2.7.1-cleanup-data-management`

**What to Remove**:
- Duplicate React Query hooks (already in useGameDataManagement)
- Duplicate data fetching effects
- Duplicate mutation definitions
- Duplicate loading state derivations

**Verification**:
- [ ] Data loading still works
- [ ] CRUD operations still work
- [ ] Tests pass

---

### PR 2: Remove Session & Field Duplicates (~1.5 hours)
**Branch**: `refactor/2.7.2-cleanup-session-field`

**What to Remove**:
- Duplicate game session state management (already in useGameSessionCoordination)
- Duplicate history management
- Duplicate field state handlers (already in useFieldCoordination)
- Duplicate tactical board state

**Verification**:
- [ ] Game session updates correctly
- [ ] Undo/redo works
- [ ] Field interactions work
- [ ] Tactical board works
- [ ] Tests pass

---

### PR 3: Remove Persistence & Timer Duplicates (~1.5 hours)
**Branch**: `refactor/2.7.3-cleanup-persistence-timer`

**What to Remove**:
- Duplicate auto-save logic (already in useGamePersistence)
- Duplicate save/load handlers
- Duplicate timer logic (already in useTimerManagement)
- Duplicate goal logging handlers

**Verification**:
- [ ] Auto-save works
- [ ] Manual save works
- [ ] Load game works
- [ ] Timer works
- [ ] Goal logging works
- [ ] Tests pass

---

### PR 4: Remove Modal Duplicates & Final Cleanup (~1 hour)
**Branch**: `refactor/2.7.4-final-cleanup`

**What to Remove**:
- Duplicate modal state (already in useModalOrchestration)
- Duplicate modal handlers
- Unused imports
- Dead code
- `initialState` object (move to config if needed)

**Final File Should Be**:
- ~200 lines
- Only coordination logic
- All state management delegated to hooks

**Verification**:
- [ ] All modals work
- [ ] All flows work end-to-end
- [ ] No console errors
- [ ] Tests pass
- [ ] Build succeeds

---

## Testing Strategy

### Before Starting
```bash
npm test -- --coverage
# Record baseline: X tests passing, Y% coverage
```

### After Each PR
```bash
npm test
npm run build
npm run lint
```

### After Final PR
1. Full test suite
2. Manual testing of all flows:
   - New game creation
   - Load/save game
   - Field interactions
   - Timer operations
   - All modals
3. PWA install and test

---

## Rollback Strategy

Each PR is independent and can be reverted:
```bash
git revert <commit-hash>
```

Keep original `useGameOrchestration.ts` in git history for reference.

---

## Success Criteria

- [ ] `useGameOrchestration.ts` â‰¤ 250 lines
- [ ] All 6 extracted hooks used
- [ ] No duplicated logic
- [ ] All tests pass
- [ ] All functionality preserved
- [ ] Build succeeds
- [ ] Clean lint

---

## Dependencies

- âœ… Step 2.6.1: useGameDataManagement
- âœ… Step 2.6.2: useGameSessionCoordination
- âœ… Step 2.6.3: useFieldCoordination
- âœ… Step 2.6.4: useGamePersistence
- âœ… Step 2.6.5: useTimerManagement
- âœ… Step 2.6.6: useModalOrchestration

---

## After This Step

Once Step 2.7 is complete:
1. **GameSettingsModal refactoring** becomes the next priority
2. See [P1-GameSettingsModal-Refactoring-Plan.md](../05-development/fix-plans/P1-GameSettingsModal-Refactoring-Plan.md)

---

**Created**: 2025-12-04
**Document Owner**: Development Team
