# Layer 2 — Step 2.4: HomePage Reduction via View‑Models

Goal
- Reduce HomePage coupling and prop explosion by introducing small, typed view‑models first, with zero runtime behavior change.

Scope (this series)
- GameContainer: introduce `GameContainerViewModel` and an adapter that derives it from current HomePage state.
- Keep GameContainer backwards compatible initially (accept both old props and the view‑model) to enable incremental migration.
- Add targeted tests and manual checks; run CI (lint/types/tests/build) each microstep.

Microsteps
1) 2.4.0 Types + Adapter (no runtime change)
   - Add `src/viewModels/gameContainer.ts` with interfaces and a `buildGameContainerViewModel()` function.
   - Unit tests for adapter with representative fixtures.
   - Wire nothing yet; ship types + tests only.

2) 2.4.1 HomePage → build + pass view‑model (keep old props)
   - HomePage constructs the view‑model and passes it alongside existing props to GameContainer.
   - GameContainer keeps using old props; no UI change.
   - Add a smoke test ensuring render remains stable.

3) 2.4.2 GameContainer consumes view‑model (feature‑flagged)
   - Add a guarded path in GameContainer to read from the view‑model for a small, isolated subset (e.g., player bar read‑only data).
   - Keep old props as fallback; parity test verifies outputs are identical.

4) 2.4.3 Remove duplicated props for the subset
   - Remove only those props replaced in 2.4.2; broaden usage in later PRs.

Non‑Goals (defer to later PRs)
- FieldContainer view‑model, `useNewGameFlow` parameter grouping, and reducer consolidation for other modals.

Regression Tests (scoped)
- GameContainer props parity for the migrated subset.
- Smoke test for HomePage render with view‑model present.

Manual Checklist
- Load Game, New Game, and Stats modals still open smoothly (Layer 1 behaviors intact).
- Player bar, field placements, and control bar still function.
- PWA paths: open offline, cached translations load.

Risks & Mitigations
- Risk: Silent divergence between old props and view‑model. Mitigate with parity assertions in tests.
- Risk: Large diffs. Mitigate by limiting the first migration to a tiny subset.

Rollback
- Revert the GameContainer view‑model usage commit; adapter/types are additive and safe to keep.


Status (updated: 2025‑11‑17)

- [x] 2.4.0 Types + Adapter (no runtime change)
  - Added `src/viewModels/gameContainer.ts` and unit tests.
- [x] 2.4.1 HomePage builds + passes view‑model (kept old props)
  - Smoke tests confirm no UI change.
- [x] 2.4.2 GameContainer consumes VM for a small, read‑only subset
  - Parity tests ensure identical output vs old props.
- [x] 2.4.3 First deletion pass for that subset + related cleanups
  - Enforced single field render path via `FieldContainer` (removed legacy inline block).
  - Compact GameInfoBar to free space on mobile.
  - Introduced robust tactical history (`useTacticalHistory`) to fix mobile undo/redo regressions discovered during testing of this step.
  - Gated noisy render logs behind env flags to improve manual verification.
- [x] 2.4.4 PlayerBar/GameInfo & FieldContainer view-model adoption
  - Added `fieldVM` + `timerVM` wrappers to `FieldContainer`, dropping 20+ primitive props after a compatibility window.
  - HomePage now constructs and passes cohesive objects (players/opponents/drawings + timer state) mirroring the `buildGameContainerViewModel` shape.
  - Updated tests + GameContainer wiring to keep PlayerBar/GameInfo props sourced from the VM, eliminating duplicated plumbing.
- [x] 2.4.5 Debug instrumentation unification
  - Added `src/utils/debug.ts` helper + regression tests and documented `NEXT_PUBLIC_DEBUG`/`NEXT_PUBLIC_DEBUG_ALL` usage in `.env.example`.
  - Migrated `HomePage`, `useGameSessionWithHistory`, `useTacticalHistory`, `useTacticalBoard`, and `ControlBar` to `debug.enabled('category')`.
  - Logging for `home`, `history`, and `tactical` flows now shares a single switch, reducing console noise between refactor steps.
- [x] 2.4.6 PlayerBar/GameInfo VM-only consumption + new game flow grouping
  - `HomePage` now renders `PlayerBar`/`GameInfoBar` directly from `buildGameContainerViewModel`, ensuring VM parity before wiring the GameContainer wrapper.
  - `GameContainer` requires a `viewModel` prop (fixtures/tests updated) so missing data fails fast.
  - `useNewGameFlow` options collapsed into `{ gameState, ui, orchestration, dependencies }`, replacing the prior 31-parameter signature.
- [x] 2.4.7 Field interactions VM + reducer-driven modal intents
  - Added `FieldInteractions`/`TimerInteractions` objects to FieldContainer so all handler props are grouped and memoized before rendering.
  - HomePage constructs these interaction VMs and passes them (plus `reducerDrivenModals.newGameSetup.open`) to the FirstGame guide + FieldContainer.
  - Load Game shortcuts and guide flows now use the modal reducer’s open/close helpers, paving the way for centralized modal orchestration.
- [x] 2.4.8 Modal reducer expansion + FieldContainer sub-VMs
  - Split `FieldInteractions` into `players`, `opponents`, `drawing`, `tactical`, and `touch` sub-objects and updated `GameContainer`/Field tests so SoccerField receives stable callbacks.
  - Extended `modalReducer` + `ModalProvider` to cover `roster` and `seasonTournament` IDs, exposing reducer-driven helpers that HomePage threads to the first-game CTA, ControlBar routes, and FieldContainer props.
  - Added reducer regression tests (roster/season toggles, anti-flash guards) and CTA interaction tests to keep the new wiring locked down.
- [x] 2.4.9 ControlBar/ModalManager reducer adoption
  - Removed the final direct modal setters inside ControlBar + ModalManager so every shortcut, CTA, and “manage roster” hop drives the centralized reducer helpers.
  - Added a regression test (`tests/integration/regression/controlBar.modal-guard.test.tsx`) to prove the Load/New modal anti-flash guard holds when ControlBar fires multiple intents.
  - Documented the reducer-driven modal helper pattern (`src/types/modals.ts`) so future migrations know how to wrap reducer state.

Notes
- The tactical history work landed in this step because verification exposed a regression in the existing stack. The fix is self‑contained (separate stack for tactics) and test‑backed.
- Step 2.4.5 was pulled forward to stabilize debugging noise ahead of the remaining prop-grouping work.

Next (2.5 — Edge-case tests)
- Add regression coverage for backup restore → latest game fallback (stale `currentGameId`) and `useGameState` availablePlayers → playersOnField sync.
- Stabilize these flows before moving to Layer 3 perf/error-handling work.
