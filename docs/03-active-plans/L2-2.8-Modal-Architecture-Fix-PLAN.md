# Layer 2 â€” Step 2.8: Modal Architecture Fix (76-Parameter Anti-Pattern)

**Status**: ðŸ”´ **NOT STARTED** (Waiting for PR #103 merge)
**Priority**: ðŸ”´ **HIGH** â€” 8/10 severity architectural anti-pattern
**Estimated Effort**: 20-27 hours (8 PRs over 2-3 weeks)
**Prerequisites**: Step 2.7 âœ… Complete, PR #103 merged to master

---

## Problem Statement

`useModalOrchestration` receives **76 parameters** (industry standard: 3-5). This is a God Object anti-pattern that:
- Makes testing practically impossible (200+ lines mock setup)
- Violates Single Responsibility Principle
- Creates tight coupling across the entire modal system
- Has 83-line destructure statement (lines 178-260 in useModalOrchestration.ts)

| Metric | Industry Standard | Current |
|--------|-------------------|---------|
| Hook parameters | 3-5 | **76** |
| Destructure lines | 3-5 | **83** |
| Test mock setup | <30 lines | **200+ lines** |

---

## Solution: Domain-Driven Hook Decomposition

Split into 5 focused domain hooks + 1 aggregator:

| Hook | Purpose | Params | Est. Lines |
|------|---------|--------|------------|
| `useGameSettingsModals` | Game metadata config | 8-10 | ~150 |
| `useRosterModals` | Player/team management | 6-8 | ~120 |
| `useStatsExportModals` | Stats, goals, export | 5-7 | ~130 |
| `useSystemModals` | App settings, resources | 5-7 | ~80 |
| `useConfirmationDialogs` | Confirmation dialogs | 6-8 | ~100 |
| `useModalAggregator` | Combines for ModalManager | 5 hooks | ~50 |

---

## Branch Strategy

```
master (after PR #103 merge)
  â””â”€â”€ integration/2.8-modal-architecture   (integration branch)
        â”œâ”€â”€ refactor/2.8.1-modal-types-setup
        â”œâ”€â”€ refactor/2.8.2-game-settings-modals
        â”œâ”€â”€ refactor/2.8.3-roster-modals
        â”œâ”€â”€ refactor/2.8.4-stats-export-modals
        â”œâ”€â”€ refactor/2.8.5-system-modals
        â”œâ”€â”€ refactor/2.8.6-confirmation-dialogs
        â”œâ”€â”€ refactor/2.8.7-modal-aggregator
        â””â”€â”€ refactor/2.8.8-migration-cleanup
```

### Workflow

1. **Create integration branch from master** (after PR #103 merge):
   ```bash
   git checkout master
   git pull
   git checkout -b integration/2.8-modal-architecture
   git push -u origin integration/2.8-modal-architecture
   ```

2. **Create feature branches from integration**:
   ```bash
   git checkout integration/2.8-modal-architecture
   git checkout -b refactor/2.8.1-modal-types-setup
   ```

3. **PRs target integration branch** (not master)

4. **Final PR to master** after all 8 PRs merged to integration

---

## PR Breakdown (8 PRs)

### PR 1: Setup Types & Directory Structure (~1 hour)
**Branch**: `refactor/2.8.1-modal-types-setup`

**Creates**:
```
src/components/HomePage/hooks/modals/
â”œâ”€â”€ index.ts           # Barrel exports
â””â”€â”€ types.ts           # Shared modal types
```

**types.ts contents**:
- `ModalStateSlice` - per-modal state (isOpen, data)
- `ModalHandlers<T>` - open/close/toggle handlers
- `GameSettingsModalParams` - focused interface (8-10 params)
- `RosterModalParams` - focused interface (6-8 params)
- `StatsExportModalParams` - focused interface (5-7 params)
- `SystemModalParams` - focused interface (5-7 params)
- `ConfirmationDialogParams` - focused interface (6-8 params)

**Verification**:
- [ ] Types compile (no errors)
- [ ] Index exports work
- [ ] Build passes

---

### PR 2: Extract useGameSettingsModals (~2-3 hours)
**Branch**: `refactor/2.8.2-game-settings-modals`

**Handles these modals**:
- `isGameSettingsModalOpen` + handlers
- `isSeasonModalOpen` + handlers
- `isTournamentModalOpen` + handlers
- `isNewGameModalOpen` + handlers
- `isLoadGameModalOpen` + handlers

**Parameters (8-10)**:
- `seasons`, `tournaments` (data)
- `currentSeason`, `currentTournament` (selections)
- `onSeasonSelect`, `onTournamentSelect` (callbacks)
- `onNewGameStart`, `onLoadGame` (actions)

**Verification**:
- [ ] Game settings modal opens/closes
- [ ] Season modal works
- [ ] Tournament modal works
- [ ] New game flow works
- [ ] Load game flow works
- [ ] Tests pass

---

### PR 3: Extract useRosterModals (~2-3 hours)
**Branch**: `refactor/2.8.3-roster-modals`

**Handles these modals**:
- `isRosterModalOpen` + handlers
- `isAddPlayerModalOpen` + handlers
- `isEditPlayerModalOpen` + handlers + `playerToEdit`
- `isDeletePlayerConfirmOpen` + handlers

**Verification**:
- [ ] Roster modal opens/closes
- [ ] Add player works
- [ ] Edit player works
- [ ] Delete player works
- [ ] Tests pass

---

### PR 4: Extract useStatsExportModals (~2-3 hours)
**Branch**: `refactor/2.8.4-stats-export-modals`

**Handles these modals**:
- `isGameStatsModalOpen` + handlers
- `isPlayerStatsModalOpen` + handlers
- `isGoalLogModalOpen` + handlers
- `isExportModalOpen` + handlers
- `isBackupRestoreModalOpen` + handlers

**Verification**:
- [ ] Game stats modal shows correct data
- [ ] Player stats modal works
- [ ] Goal log displays correctly
- [ ] Export works
- [ ] Backup/restore works
- [ ] Tests pass

---

### PR 5: Extract useSystemModals (~1-2 hours)
**Branch**: `refactor/2.8.5-system-modals`

**Handles these modals**:
- `isAppSettingsModalOpen` + handlers
- `isResourcesModalOpen` + handlers
- `isAboutModalOpen` + handlers
- `isTimerAlertsModalOpen` + handlers

**Verification**:
- [ ] App settings modal works
- [ ] Resources modal opens
- [ ] About modal opens
- [ ] Timer alerts modal works
- [ ] Tests pass

---

### PR 6: Extract useConfirmationDialogs (~1-2 hours)
**Branch**: `refactor/2.8.6-confirmation-dialogs`

**Handles these dialogs**:
- `isResetGameConfirmOpen` + handlers
- `isDeleteGameConfirmOpen` + handlers + `gameToDelete`
- `isEndGameConfirmOpen` + handlers
- `isUnsavedChangesConfirmOpen` + handlers

**Verification**:
- [ ] Reset game confirmation works
- [ ] Delete game confirmation works
- [ ] End game confirmation works
- [ ] Unsaved changes warning works
- [ ] Tests pass

---

### PR 7: Create useModalAggregator (~2 hours)
**Branch**: `refactor/2.8.7-modal-aggregator`

**Creates**: `useModalAggregator.ts`

```typescript
export function useModalAggregator(params: ModalAggregatorParams) {
  const gameSettings = useGameSettingsModals(params.gameSettings);
  const roster = useRosterModals(params.roster);
  const statsExport = useStatsExportModals(params.statsExport);
  const system = useSystemModals(params.system);
  const confirmations = useConfirmationDialogs(params.confirmations);

  // Build ModalManagerProps (unchanged interface)
  return {
    modalManagerProps: buildModalManagerProps({
      gameSettings,
      roster,
      statsExport,
      system,
      confirmations,
    }),
  };
}
```

**Verification**:
- [ ] Returns valid ModalManagerProps
- [ ] All modal props present
- [ ] ModalManager renders correctly
- [ ] Tests pass

---

### PR 8: Migration & Cleanup (~3-4 hours)
**Branch**: `refactor/2.8.8-migration-cleanup`

**Phase 1: Update useModalOrchestration**
```typescript
// BEFORE: 581 lines, 76 parameters
export function useModalOrchestration(params: UseModalOrchestrationParams) {
  // ... 83-line destructure
  // ... 500+ lines of logic
}

// AFTER: ~50 lines, 5 parameter objects
export function useModalOrchestration(params: UseModalOrchestrationParams) {
  return useModalAggregator({
    gameSettings: params.gameSettings,
    roster: params.roster,
    statsExport: params.statsExport,
    system: params.system,
    confirmations: params.confirmations,
  });
}
```

**Phase 2: Update useGameOrchestration**
- Update the call site (lines 1869-1957)
- Replace 76-param spread with 5 focused objects

**Phase 3: Cleanup**
- Remove old `UseModalOrchestrationParams` interface
- Remove duplicate types
- Run full test suite

**Verification**:
- [ ] All 2,025+ tests pass
- [ ] Build succeeds
- [ ] Lint clean
- [ ] Manual testing: all modals work
- [ ] ModalManager interface unchanged

---

### Final PR: Integration â†’ Master
**Branch**: `integration/2.8-modal-architecture` â†’ `master`

**Verification**:
1. Full test suite passes
2. Build succeeds
3. Manual testing of ALL modals
4. PWA install and test
5. Test in both English and Finnish

---

## New Directory Structure (Final)

```
src/components/HomePage/hooks/modals/
â”œâ”€â”€ index.ts
â”œâ”€â”€ types.ts
â”œâ”€â”€ useGameSettingsModals.ts
â”œâ”€â”€ useRosterModals.ts
â”œâ”€â”€ useStatsExportModals.ts
â”œâ”€â”€ useSystemModals.ts
â”œâ”€â”€ useConfirmationDialogs.ts
â”œâ”€â”€ useModalAggregator.ts
â””â”€â”€ __tests__/
    â”œâ”€â”€ useGameSettingsModals.test.ts
    â”œâ”€â”€ useRosterModals.test.ts
    â”œâ”€â”€ useStatsExportModals.test.ts
    â”œâ”€â”€ useSystemModals.test.ts
    â”œâ”€â”€ useConfirmationDialogs.test.ts
    â””â”€â”€ useModalAggregator.test.ts
```

---

## Critical Files

**Modified**:
- `src/components/HomePage/hooks/useModalOrchestration.ts` (581 â†’ ~50 lines)
- `src/components/HomePage/hooks/useGameOrchestration.ts` (update call site)

**Created**:
- 6 new hook files + 1 types file + 1 index file
- 6 test files

**Unchanged**:
- `src/components/HomePage/containers/ModalManager.tsx` (interface unchanged)
- `src/contexts/ModalProvider.tsx` (unchanged)

---

## Success Criteria

- [ ] Each domain hook has max 8-12 parameters
- [ ] Each hook testable with <30 lines mock setup
- [ ] All 2,025+ tests pass
- [ ] `useModalOrchestration.ts` reduced from 581 to ~50 lines
- [ ] `useGameOrchestration.ts` call site cleaner (5 objects vs 76 params)
- [ ] ModalManager interface unchanged (backward compatible)
- [ ] Build and lint pass

---

## Risk Mitigation

1. **Backward compatibility**: Keep original as `useModalOrchestration.legacy.ts` during development
2. **Incremental**: Each PR produces working code
3. **Rollback**: Can stop/rollback at any phase boundary
4. **Testing**: Each hook has dedicated tests before migration

---

## Timeline Estimate

| PR | Estimated Time | Cumulative |
|----|---------------|------------|
| PR 1 (Setup) | 1h | 1h |
| PR 2 (Game Settings) | 2-3h | 3-4h |
| PR 3 (Roster) | 2-3h | 5-7h |
| PR 4 (Stats/Export) | 2-3h | 7-10h |
| PR 5 (System) | 1-2h | 8-12h |
| PR 6 (Confirmations) | 1-2h | 9-14h |
| PR 7 (Aggregator) | 2h | 11-16h |
| PR 8 (Migration) | 3-4h | 14-20h |
| Final PR | 1h | 15-21h |
| Buffer | 5-6h | **20-27h** |

**Realistic Schedule**: 2-3 weeks with 2-3 hours per day

---

## Dependencies

- âœ… Step 2.6: Hook extractions complete
- âœ… Step 2.7: useGameOrchestration cleanup complete (PR #103)
- ðŸ”´ PR #103 merge required before starting

---

## After This Step

Once Step 2.8 is complete:
1. **useModalOrchestration**: 581 â†’ ~50 lines (91% reduction)
2. **Test mock setup**: 200+ â†’ <30 lines (85% reduction)
3. **Parameters**: 76 â†’ 5 domain objects (industry standard)
4. Next priority: GameSettingsModal refactoring (1,995 lines)

---

**Created**: 2025-12-04
**Updated**: 2025-12-04
**Document Owner**: Development Team
