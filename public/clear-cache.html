<!DOCTYPE html>
<html>
<head>
    <title>Clear Service Worker & Cache</title>
    <style>
        body { font-family: monospace; padding: 40px; background: #1a1a1a; color: #0f0; }
        button { background: #0f0; color: #000; padding: 15px 30px; margin: 10px; border: none; cursor: pointer; font-size: 16px; }
        button:hover { background: #0a0; }
        pre { background: #000; padding: 15px; overflow-x: auto; border: 1px solid #0f0; }
        .success { color: #0f0; }
        .error { color: #f00; }
    </style>
</head>
<body>
    <h1>MatchOps Cache Cleaner</h1>
    <p>This will unregister all service workers and clear all caches.</p>

    <button onclick="clearEverything()">CLEAR ALL CACHES & SERVICE WORKERS</button>
    <button onclick="clearIndexedDB()">CLEAR INDEXEDDB (WARNING: DELETES ALL DATA)</button>

    <h2>Output:</h2>
    <pre id="output">Ready...</pre>

    <script>
        const output = document.getElementById('output');

        function log(msg, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'error' : 'success';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${msg}</span>\n`;
            console.log(msg);
        }

        async function clearEverything() {
            output.innerHTML = '';
            log('Starting cleanup...');

            try {
                // 1. Unregister all service workers
                log('\n=== UNREGISTERING SERVICE WORKERS ===');
                if ('serviceWorker' in navigator) {
                  const registrations = await navigator.serviceWorker.getRegistrations();
                  log(`Found ${registrations.length} service worker(s)`);
                  for (let registration of registrations) {
                      await registration.unregister();
                      log(`✓ Unregistered: ${registration.scope}`);
                  }
                } else {
                  log('Service workers not supported in this browser');
                }

                // 2. Clear all caches
                if ('caches' in window) {
                  log('\n=== CLEARING CACHES ===');
                  const cacheNames = await caches.keys();
                  log(`Found ${cacheNames.length} cache(s)`);
                  for (let cacheName of cacheNames) {
                      await caches.delete(cacheName);
                      log(`✓ Deleted cache: ${cacheName}`);
                  }
                }

                // 3. Clear localStorage
                log('\n=== CLEARING LOCALSTORAGE ===');
                const lsKeys = Object.keys(localStorage);
                log(`Found ${lsKeys.length} localStorage key(s)`);
                localStorage.clear();
                log('✓ Cleared localStorage');

                // 4. Clear sessionStorage
                log('\n=== CLEARING SESSIONSTORAGE ===');
                sessionStorage.clear();
                log('✓ Cleared sessionStorage');

                log('\n✅ ALL DONE! Please close ALL tabs/windows of MatchOps and restart the app.');
                log('Then navigate to the NEW port shown in the terminal.');

            } catch (error) {
                log(`❌ ERROR: ${error.message}`, true);
                console.error(error);
            }
        }

        async function clearIndexedDB() {
            if (!confirm('WARNING: This will DELETE ALL YOUR GAME DATA!\n\nAre you sure?')) {
                return;
            }

            output.innerHTML = '';
            log('⚠️  DELETING ALL DATA...');

            try {
                // Delete IndexedDB
                log('\n=== DELETING INDEXEDDB ===');
                if ('databases' in indexedDB) {
                  const dbs = await indexedDB.databases();
                  for (let db of dbs) {
                      if (db.name) {
                          await new Promise((resolve, reject) => {
                              const req = indexedDB.deleteDatabase(db.name);
                              req.onsuccess = () => { log(`✓ Deleted database: ${db.name}`); resolve(); };
                              req.onerror = () => reject(req.error);
                          });
                      }
                  }
                } else {
                  // Fallback: try to delete our known DB
                  await new Promise((resolve, reject) => {
                      const req = indexedDB.deleteDatabase('MatchOpsLocal');
                      req.onsuccess = () => { log('✓ Deleted database: MatchOpsLocal'); resolve(); };
                      req.onerror = () => reject(req.error);
                  });
                }

                await clearEverything();
                log('\n⚠️  ALL DATA DELETED! The app will start fresh.');

            } catch (error) {
                log(`❌ ERROR: ${error.message}`, true);
                console.error(error);
            }
        }
    </script>
</body>
</html>

